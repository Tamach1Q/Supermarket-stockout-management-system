<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ¬ å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body { font-family: sans-serif; display: flex; gap: 20px; padding: 20px; background: #f4f4f4;}
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; }
        canvas { border: 1px solid #ccc; cursor: crosshair; background: #eee; }
        
        /* é€šçŸ¥ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #notification-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
        .alert-item { 
            padding: 10px; margin-bottom: 10px; border-left: 5px solid red; 
            background: #fff0f0; animation: flash 1s; 
        }
        @keyframes flash { from { background: yellow; } to { background: #fff0f0; } }
        .alert-time { font-size: 0.8em; color: #666; }
        .alert-msg { font-weight: bold; font-size: 1.1em; }
    </style>
</head>
<body>

    <div class="panel">
        <h2>ğŸ› ï¸ åº—èˆ—ãƒãƒƒãƒ—è¨­å®š</h2>
        <p>ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦å•†å“ã‚¨ãƒªã‚¢ã‚’å›²ã£ã¦ãã ã•ã„</p>
        <canvas id="mapCanvas" width="600" height="400"></canvas>
        <br>
        <button onclick="saveAreas()">è¨­å®šã‚’ä¿å­˜ã™ã‚‹</button>
        <button onclick="clearAreas()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="panel" style="width: 300px;">
        <h2>ğŸ”” æ¬ å“é€šçŸ¥ãƒ­ã‚°</h2>
        <div id="status">ç›£è¦–ä¸­...</div>
        <ul id="notification-list">
            </ul>
    </div>

<script>
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    let areas = [];
    let isDrawing = false, startX, startY;

    // èƒŒæ™¯ç”»åƒï¼ˆåœ°å›³ï¼‰ã®èª­ã¿è¾¼ã¿
    // NOTE:
    // - ã“ã®ç”»é¢ã¯ `app.py` çµŒç”±ã§é–‹ãæƒ³å®šï¼ˆ`/static/map.png` ãŒé…ä¿¡ã•ã‚Œã‚‹ï¼‰
    // - `templates/index.html` ã‚’ç›´æ¥ file:// ã§é–‹ãã¨ `/api/*` ã‚„ `/static/*` ãŒè§£æ±ºã§ããšåœ°å›³ãŒè¦‹ãˆãªã„ã“ã¨ãŒã‚ã‚‹
    const mapImg = new Image();
    let useFallbackMap = true;

    function mapSrc() {
        // file:// ã§ç›´æ¥é–‹ã‹ã‚ŒãŸå ´åˆã¯ç›¸å¯¾ãƒ‘ã‚¹ã«å¯„ã›ã‚‹ï¼ˆè¦‹ãˆã‚‹ã ã‘ã§ã‚‚è¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰
        if (location.protocol === 'file:') return '../static/map.png';
        // ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã®ãŸã‚ã€ã‚¯ã‚¨ãƒªã‚’ä»˜ã‘ã¦æ¯å›æ–°ã—ã„URLã«ã™ã‚‹
        return '/static/map.png?t=' + Date.now();
    }

    mapImg.onload = () => { useFallbackMap = false; draw(); };
    mapImg.onerror = () => { useFallbackMap = true; draw(); };
    mapImg.src = mapSrc();

    // åˆæœŸæç”»ï¼ˆç”»åƒãƒ­ãƒ¼ãƒ‰å‰ã§ã‚‚çœŸã£ç™½ã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼‰
    draw();

    // åœ°å›³ã¯ã‚µãƒ¼ãƒå´ã§æ›´æ–°ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚å®šæœŸãƒªãƒ­ãƒ¼ãƒ‰
    // TODO(å¾Œã§ä¿®æ­£): æ›´æ–°é »åº¦ã¯é‹ç”¨ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„
    setInterval(() => {
        // file:// ã®å ´åˆã¯APIã‚‚ä½¿ãˆãªã„ã®ã§ã€ã“ã“ã§ã¯æ›´æ–°ã—ãªã„
        if (location.protocol === 'file:') return;
        mapImg.src = mapSrc();
    }, 10000);

    // --- ã‚­ãƒ£ãƒ³ãƒã‚¹æ“ä½œ ---
    canvas.addEventListener('mousedown', e => {
        const rect = canvas.getBoundingClientRect();
        startX = e.clientX - rect.left; startY = e.clientY - rect.top;
        isDrawing = true;
    });
    
    canvas.addEventListener('mousemove', e => {
        if(!isDrawing) return;
        draw();
        const rect = canvas.getBoundingClientRect();
        const currX = e.clientX - rect.left; const currY = e.clientY - rect.top;
        ctx.strokeStyle = 'blue'; ctx.lineWidth = 2;
        ctx.strokeRect(startX, startY, currX - startX, currY - startY);
    });

    canvas.addEventListener('mouseup', e => {
        isDrawing = false;
        const rect = canvas.getBoundingClientRect();
        const endX = e.clientX - rect.left; const endY = e.clientY - rect.top;
        const w = Math.abs(endX - startX); const h = Math.abs(endY - startY);
        if(w < 10 || h < 10) { draw(); return; } // å°ã•ã™ããŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«

        const name = prompt("ã‚¨ãƒªã‚¢åã‚’å…¥åŠ› (ä¾‹: ã‚³ãƒ¼ãƒ©)");
        if(name) {
            areas.push({ name, x: Math.min(startX, endX), y: Math.min(startY, endY), w, h });
            saveAreas(); // å³ä¿å­˜
        }
        draw();
    });

    function draw() {
        ctx.clearRect(0,0, canvas.width, canvas.height);
        if (!useFallbackMap && mapImg.complete) {
            try {
                ctx.drawImage(mapImg, 0, 0, 600, 400);
            } catch (e) {
                // 0ãƒã‚¤ãƒˆç”»åƒãªã©ã€Œå£Šã‚ŒãŸç”»åƒã€ã®å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
                useFallbackMap = true;
            }
        }

        if (useFallbackMap) {
            if (statusEl) statusEl.textContent = 'åœ°å›³æœªå–å¾—ï¼ˆç°¡æ˜“ãƒãƒƒãƒ—è¡¨ç¤ºä¸­ï¼‰';
            // ç”»åƒãŒç„¡ã„/å£Šã‚Œã¦ã„ã‚‹å ´åˆã®ç°¡æ˜“ãƒãƒƒãƒ—ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, 600, 400);

            ctx.fillStyle = '#d0d0d0';
            ctx.fillRect(50, 50, 100, 200);  // æ£šA
            ctx.fillRect(250, 50, 100, 200); // æ£šB

            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('Shelf A', 60, 150);
            ctx.fillText('Shelf B', 260, 150);

            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.fillText('â€» map.png ãŒèª­ã¿è¾¼ã‚ãªã„ãŸã‚ç°¡æ˜“è¡¨ç¤ºä¸­ï¼ˆapp.py çµŒç”±ã§é–‹ã/ generate_dummy.py ã§ç”Ÿæˆï¼‰', 10, 390);
        } else {
            if (statusEl) statusEl.textContent = 'ç›£è¦–ä¸­...';
        }
        
        areas.forEach(a => {
            ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
            ctx.fillRect(a.x, a.y, a.w, a.h);
            ctx.fillStyle = 'red'; ctx.font = 'bold 14px Arial';
            ctx.fillText(a.name, a.x, a.y - 5);
        });
    }

    // --- APIé€£æº ---
    function saveAreas() {
        fetch('/api/save_areas', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(areas)
        }).then(()=> console.log("ä¿å­˜ã—ã¾ã—ãŸ"));
    }

    function clearAreas() {
        areas = [];
        saveAreas();
        draw();
    }

    function loadAreas() {
        fetch('/api/load_areas').then(r => r.json()).then(data => {
            areas = data; draw();
        });
    }

    // --- å®šæœŸãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆé€šçŸ¥ãƒã‚§ãƒƒã‚¯ï¼‰ ---
    let lastCount = 0;
    setInterval(() => {
        fetch('/api/notifications').then(r => r.json()).then(data => {
            if (data.length > lastCount) {
                // æ–°ã—ã„é€šçŸ¥ãŒã‚ã‚‹å ´åˆã ã‘æ›´æ–°
                const list = document.getElementById('notification-list');
                list.innerHTML = ""; // ã‚¯ãƒªã‚¢
                data.forEach(n => {
                    const li = document.createElement('li');
                    li.className = 'alert-item';
                    li.innerHTML = `<div class="alert-time">${n.time}</div>
                                    <div class="alert-msg">âš ï¸ ${n.area}</div>
                                    <div>åº§æ¨™: ${n.coords}</div>`;
                    list.appendChild(li);
                });
                lastCount = data.length;
            }
        });
    }, 1000); // 1ç§’ã”ã¨ã«æ›´æ–°

    loadAreas(); // åˆæœŸèª­ã¿è¾¼ã¿
</script>
</body>
</html>
